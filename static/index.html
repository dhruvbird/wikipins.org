<html>
  <head>
    <title>Wikipins.org</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="/static/jquery.wookmark.js"></script>
    <script type="text/javascript" src="/static/md5.js"></script>
    <script type="text/javascript" src="/static/imagesLoaded.js"></script>
    <script type="text/javascript" src="/static/underscore-min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css">

    <style type="text/css">
      body {
          background-color: #EEEEEE;
          font-family: sans-serif;
          margin: 5px 0px 0px 0px;
          position: absolute;
          top: 80px;
      }
      #header span {
          font-size: 18px;
      }
      #header {
          position: fixed;
          top: -1px;
          background-color: #EEE;
          width: 100%;
          padding: 10px 0 10px 0;
          -webkit-box-shadow: inset 0 1px white,0 1px 3px rgba(34, 25, 25, 0.4);
          box-shadow: inset 0 1px white,0 1px 3px rgba(34, 25, 25, 0.4);
      }
      #pin-template, #article-pin-template {
          display: none;
      }
      div.pin-before-wookmark {
          float: left;
          margin: 10px 10px 10px 10px;
      }
      div.pin {
          width: 240px;
          padding: 15px 15px 15px 15px;
          box-shadow: 0 1px 3px rgba(34, 25, 25, 0.4);
          -webkit-box-shadow: 0 1px 3px rgba(34, 25, 25, 0.4);
          background-color: #FFFFFF;
      }
      a.pin-click {
          display: block;
          text-decoration: none;
          color: #000000;
      }
      .clear-both {
          clear: both;
      }
      #content {
          position: relative;
      }
      .category-name, .title {
          font-weight: bold;
          font-size: 20px;
          text-align: center;
          margin-bottom: 5px;
      }
      #content-wrapper {
          margin-bottom: 150px;
      }
      div.bigger {
          overflow: hidden;
          width: 240px;
      }
      .abstract {
          margin-top: 15px;
          font-family: "Helvetica Neue","Segoe UI","Nimbus Sans L","Liberation Sans","Open Sans",FreeSans,Arial,sans-serif;
      }
      div.vspacer {
          position: absolute;
          height: 120px;
      }
      .search {
          width: 300px;
          margin-left: 25px;
      }
      #search-box {
          margin-right: 0;
          float: left;
      }
      #search-button {
          margin-left: 0px;
          width: 25px;
          float: left;
      }
      #htext {
          margin: auto;
      }
      .ui-widget {
          font-size: 0.9em;
      }
      .search-box-initial {
          color: #888888;
      }
    </style>
  </head>

  <body>
    <div id="content-wrapper">
      <div id="content"></div>

      <div id="header">
        <div class="search">
          <input type="text" id="search-box" value="Search" />
          <input type="button" id="search-button" />
        </div>
        <div id="htext">
          <span>Wikipins - A graphical wikipedia navigation experience!</span>
        </div>
        <div class="clear-both"></div>

      </div>

    </div>

    <div id="pin-template">
      <a class="pin-click">
        <div class="category-name"></div>
        <div class="image"></div>
      </a>
    </div>

    <div id="article-pin-template">
      <a class="pin-click">
        <div class="title"></div>
        <div class="image"></div>
        <div class="abstract"></div>
      </a>
    </div>

    <script type="text/javascript">
      function get_image_url(file_name, width, ns) {
          ns = ns || 'commons'
          file_name = file_name.replace(/\ /g, "_");
          var md5sum = hex_md5(file_name);
          var img_url = '';
          if (width == 0) {
              img_url = "http://upload.wikimedia.org/wikipedia/" + ns +
                  "/" + md5sum[0] + "/" + md5sum.substr(0, 2) + "/" + file_name;
          } else {
              var thumb_name = width + "px-" + file_name;
              if (file_name.search(/\.svg$/i) != -1) {
                  thumb_name += ".png";
              }
              img_url = "http://upload.wikimedia.org/wikipedia/" + ns +
                  "/thumb/" + md5sum[0] + "/" +
                  md5sum.substr(0, 2) + "/" +
                  file_name + "/" + thumb_name;
          }
          return img_url;
      }

      function on_image_loaded() {
          // console.log(arguments);
      }
      function on_image_error_01() {
          var img = $(this);
          console.log("[1] Error loading:", img.data('img-name'));
          img.off('error')
              .on('error', on_image_error_02);
          img.attr('src', get_image_url(img.data('img-name'),
                                        0, 'commons'));
          if (img.data('img-width') == 240) {
              // Set max-height to 240px.
              img.parent().css('max-height', "240px");
          }
      }

      function on_image_error_02() {
          var img = $(this);
          console.log("[2] Error loading:", img.data('img-name'));
          img.off('error')
              .on('error', on_image_error_03);
          img.attr('src', get_image_url(img.data('img-name'),
                                        img.data('img-width'),
                                        'en'
                                       ));
      }

      function on_image_error_03() {
          var img = $(this);
          console.log("[3] Error loading:", img.data('img-name'));
          img.off('error');
          img.attr('src', get_image_url(img.data('img-name'),
                                        0, 'en'));
      }

      function item_cmp(lhs, rhs) {
          return rhs.images.length - lhs.images.length;
      }

      function filter_empty_item(item) {
          return item.images.length > 0;
      }

      function get_pin_div(item) {
          var div = $("#pin-template").clone()
              .attr("id", null)
              .addClass('pin-before-wookmark')
              .addClass("pin")
              .addClass("category-pin");
          div.find("a.pin-click").attr('href', '/c/' + escape(item.category.replace(/\ /g, '_')));
          div.find('.category-name').html(item.category);
          var images = item.images.slice(0,4);
          if (images.length === 2) {
              images = images.slice(0, 1);
          }
          var sm_width = Math.floor(240 / (images.length - 1));
          var imgs = images.map(function(img_name, idx) {
              var img_width = idx > 0 ? sm_width : 240;
              var img_url = get_image_url(img_name, img_width);
              var img  = $("<img />").attr('src', img_url)
                  .attr('width', img_width + "px")
                  .addClass('pin-image')
                  .on('load', on_image_loaded)
                  .on('error', on_image_error_01);
              if (idx > 0) {
                  img.attr('height', img_width + "px");
              }
              img.data('img-name', img_name);
              img.data('img-width', img_width);
              return img;
          });
          var bigger =  $("<div></div>").addClass("bigger");
          var smaller = $("<div></div>").addClass("smaller");
          bigger.append(imgs[0]);
          imgs.slice(1).forEach(function(img) {
              img.attr('float', 'left');
              smaller.append(img);
          });
          div.find(".image").append(bigger);
          if (imgs.length > 1) {
              smaller.append($("<div></div>").addClass("clear-both"));
              div.find(".image").append(smaller);
          }
          return div;
      }

      function get_pin_div_for_article(item) {
          var div = $("#article-pin-template").clone()
              .attr("id", null)
              .addClass('pin-before-wookmark')
              .addClass("pin")
              .addClass("article-pin");
          div.find('a.pin-click').attr('href', "http://en.wikipedia.org/wiki/" + item.title.replace(/\ /, '_'));
          div.find('.title').html(item.title);
          div.find('.abstract').html(item['abstract']);

          var img_name = item.image.trim();
          if (!img_name) {
              div.find(".image").remove();
          } else {
              var img_url  = get_image_url(img_name, 240);
              var bigger   =  $("<div></div>").addClass("bigger");
              var img      = $("<img />").attr('src', img_url)
                  .attr('width', "240px")
                  .addClass('pin-image')
                  .on('load', on_image_loaded)
                  .on('error', on_image_error_01);

              img.data('img-name', img_name);
              img.data('img-width', 240);

              bigger.append(img);
              div.find(".image").append(bigger);
          }

          return div;
      }

      function num_cmp(lhs, rhs) {
          return lhs - rhs;
      }

      function add_vspacer() {
          console.log("timedout");
          var all_bottoms = $("#content .pin").map(function() {
              var t = $(this);
              return t.position().top + t.height();
          }).sort(num_cmp);
          if (all_bottoms.length == 0) {
              return;
          }
          var max_bottom = all_bottoms[all_bottoms.length - 1];
          var vspacer = $("<div>&nbsp;</div>").
              addClass('vspacer').
              css('top', max_bottom + "px");
          $("#content").append(vspacer);
      }

      function load_category_pins(category) {
          console.log("load_category_pins(", category, ")");
          $.ajax({
              url: "/category_abstracts/",
              dataType: 'jsonp',
              data: {
                  category: category
              },
              success: function(a) {
                  a.forEach(function(item) {
                      var div  = get_pin_div_for_article(item);
                      $("#content").append(div);
                  });
                  $("#content").imagesLoaded(function() {
                      $("#content .pin").removeClass('pin-before-wookmark');
                      $("#content .pin").wookmark({
                          offset: 15,
                          itemWidth: 270
                      });
                      setTimeout(add_vspacer, 1000);
                  });
              }
          });
      }

      function load_category_list(url) {
          $.ajax({
              url:  url,
              dataType: 'jsonp',
              success: function(data) {
                  console.log(data);
                  var a = [ ];
                  var key;
                  for (key in data) {
                      var item = data[key];
                      if (item.length > 0) {
                          a.push({
                              category: key,
                              count: item[0].count,
                              images: _.pluck(item, 'image')
                          });
                      }
                  }
                  a = a.filter(filter_empty_item);
                  a.sort(item_cmp);
                  a.forEach(function(item) {
                      var div  = get_pin_div(item);
                      $("#content").append(div);
                  });
                  $("#content").imagesLoaded(function() {
                      $("#content .pin").removeClass('pin-before-wookmark');
                      $("#content .pin").wookmark({
                          offset: 15,
                          itemWidth: 270
                      });
                      setTimeout(add_vspacer, 1000);
                  });
              }
          });
      }

      function get_wiki_entries_by_prefix(term, cb) {
          $.ajax({
              url: "http://autocomplete.wikipins.org/suggest/",
              dataType: 'jsonp',
              data: { q: term.term, n: 10 },
              success: function(data) {
                  console.log(data);
                  data.articles = _.uniq(data.articles, false, function(a) {
                      return a.phrase;
                  });
                  data.categories = _.uniq(data.categories, false, function(a) {
                      return a.phrase;
                  });
                  var opts = [ ];
                  data.categories.forEach(function(e) {
                      opts.push({ label: e.phrase, value: "Category:" + e.phrase });
                  });
                  data.articles.forEach(function(e) {
                      opts.push({ label: e.phrase, value: "Article:" + e.phrase });
                  });
                  cb(opts);
              },
              error: function() {
                  cb([]);
              }
          });
      }

      $().ready(function() {
          var search_box = $("#search-box");
          search_box.data('state', 'initial');
          search_box.addClass('search-box-initial');
          search_box.focus(function(event) {
              if (search_box.data('state') == 'initial') {
                  search_box.val('');
                  search_box.removeClass('search-box-initial');
                  search_box.data('state', 'typing');
              }
          });
          search_box.blur(function(event) {
              if (jQuery.trim(search_box.val()).length == 0) {
                  search_box.addClass('search-box-initial');
                  search_box.data('state', 'initial');
                  search_box.val('Search');
              }
          });

/*
          search_box.change(function(event) {
              console.log("foo");
              if (jQuery.trim(search_box.val()).length == 0) {
                  search_box.addClass('search-box-initial');
                  search_box.data('state', 'initial');
                  search_box.val('Search');
              } else {
                  search_box.removeClass('search-box-initial');
                  search_box.data('state', 'typing');
              }
          });
*/

          search_box.keyup(function(event) {
              if (event.keyCode == 13) {
                  // alert("Sorry, not implemented");
              }
          });

          $("#search-button").click(function(event) {
              alert("Sorry, not implemented");
          });

          var m1 = window.location.pathname.match(/^\/c\/([^\/]+)\/?$/);
          if (m1) {
              var category = unescape(m1[1]).replace(/_/g, ' ');
              console.log("category:", category);
              $("#header span").html(category);
              load_category_pins(category);
          } else {
              load_category_list("/random_categories/");
          }

          var htext_width = $("#htext span").width();
          console.log("htext_width:", htext_width);

          $("#htext").css('width', (htext_width + 5) + "px");

          $("#search-box").autocomplete({
              source: get_wiki_entries_by_prefix,
              select: function(event, ui) {
                  var item = ui.item;
                  if (item.value.search(/^Category:/) == 0) {
                      window.location = "/c/" + escape(item.label.replace(' ', '_'));
                  } else {
                      window.location = "/a/" + escape(item.label.replace(' ', '_'));
                  }
              }
          });
      });
    </script>
  </body>
</html>
